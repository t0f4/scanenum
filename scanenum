#!/usr/bin/env bash
set -euo pipefail

# === Colors ===
RED="\e[1;31m"; GREEN="\e[1;32m"; YELLOW="\e[1;33m"; CYAN="\e[1;36m"; MAGENTA="\e[1;35m"; RESET="\e[0m"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export SCANENUM_ROOT="$SCRIPT_DIR"
export PATH="$SCRIPT_DIR/lib:$PATH"

source "$SCRIPT_DIR/lib/api.sh"

# === Banner ===
echo -e "${CYAN}====================================${RESET}"
echo -e "${YELLOW}tool: scanenum (modular)${RESET}"
echo -e "${YELLOW}author: t0f4${RESET}"
echo -e "${YELLOW}contributors: MasterCraft,...${RESET}"
echo -e "${YELLOW}version: 0.2 (plugin-arch)${RESET}"
echo -e "${CYAN}====================================${RESET}"

TARGET="${1:-}"
if [[ -z "$TARGET" ]]; then
  echo -e "${RED}Usage: $0 <IP|HOST> [--list-plugins|--only <comma-separated-ids>]${RESET}"
  exit 1
fi

ONLY_IDS=""
if [[ "${2:-}" == "--list-plugins" ]]; then
  list_plugins
  exit 0
elif [[ "${2:-}" == "--only" ]]; then
  ONLY_IDS="${3:-}"
fi

# Results folder (namespaced per target + timestamp)
timestamp="$(date -u +'%Y%m%dT%H%M%SZ')"
export RESULTS_DIR="scanenum_${TARGET}_${timestamp}"
mkdir -p "$RESULTS_DIR"

# Trap: allow skipping current plugin with Ctrl-C, continue with the rest
CURRENT_PID=0
skip_current=false
trap 'if [[ $CURRENT_PID -ne 0 ]]; then echo -e "${YELLOW}[!] Skipping current plugin...${RESET}"; kill -TERM $CURRENT_PID 2>/dev/null || kill -9 $CURRENT_PID 2>/dev/null; skip_current=true; fi' INT

echo -e "${GREEN}[*] Starting at: $(date -u +'%Y-%m-%d %H:%M:%SZ')${RESET}\n"
export TARGET

# Load configuration
load_config "$SCRIPT_DIR/config/default.conf"

# === Run selected plugins ===
EXIT_CODE=0
for plugin in $(resolve_plugins "$ONLY_IDS"); do
  export skip_current=false
  echo -e "${MAGENTA}---[ $(plugin_id "$plugin") ] $(plugin_name "$plugin") ---${RESET}"
  # shellcheck disable=SC1090
  source "$plugin"
  if declare -f run >/dev/null 2>&1; then
    run &
    CURRENT_PID=$!
    wait $CURRENT_PID || true
    CURRENT_PID=0
    if [[ "$skip_current" == true ]]; then
      echo -e "${YELLOW}[!] Skipped: $(plugin_name "$plugin")${RESET}\n"
    else
      echo -e "${GREEN}[+] Finished: $(plugin_name "$plugin")${RESET}\n"
    fi
    unset -f run
  else
    echo -e "${RED}[!] Plugin $(basename "$plugin") has no run() function${RESET}"
    EXIT_CODE=2
  fi
done

echo -e "${CYAN}====================================${RESET}"
echo -e "${GREEN}[*] Done. All outputs: $RESULTS_DIR/${RESET}"
exit $EXIT_CODE
